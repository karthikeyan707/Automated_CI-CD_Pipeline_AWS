pipeline {
   agent any 

   environment {
      AWS_DEFAULT_REGION = 'us-west-2'
      TF_WORKSPACE = "default"
   }


   stages {
      stage('Checkout') {
         steps {
            checkout scm
  	 }
      }

      stage('Build') {
         steps {
 	    dir('app') {
   	       sh 'npm install'
	       sh 'npm run test'
	    }
	  }
       }

       stage('Terraform Init and Plan') {
          steps {
	     withCredentials([
		file(credentialsId: 'jenkins-key-public', variable: 'PUB_KEY')
             ]) {
	       dir('terraform') {
			 sh '''cp $PUB_KEY ./jenkins-key.pub'''
	         sh 'terraform init -input=false'
		 sh """
          	    terraform plan -out=tfplan -input=false -var="key_pair_name=jenkins-key" -var="public_key_path=./jenkins-key.pub" -var="aws_region=$AWS_DEFAULT_REGION"
                 """
		 sh 'terraform show -no-color tfplan > plan.txt'
		 archiveArtifacts artifacts: 'plan.txt', allowEmptyArchive: true
	       }
	     }
           }
	}

       stage('Terraform apply') {
          steps {
	     dir('terraform') {
	        sh 'terraform apply -input=false -auto-approve tfplan'
	        sh 'terraform output -json > outputs.json'
		archiveArtifacts artifacts: 'outputs.json', allowEmptyArchive: true
	     }
	  }
	}

    stage('Deploy to EC2') {
      steps {
        script {
            // Read Terraform outputs JSON
            def outputs = readJSON file: 'terraform/outputs.json'
            def appIP = outputs.app_public_ip.value  // Use this variable consistently
            echo "App IP: ${appIP}"

            withCredentials([sshUserPrivateKey(
                credentialsId: 'jenkins-key',
                keyFileVariable: 'SSH_KEY',
            )]) {
                timeout(time: 3, unit: 'MINUTES') {
                    // Wait until SSH port is open
                    waitUntil {
                        script {
                            def result = sh(
                                script: "nc -zv ${appIP} 22",
                                returnStatus: true
                            )
                            return result == 0
                        }
                    }

                    // Deploy application
                    sh """
                        scp -o StrictHostKeyChecking=no -i $SSH_KEY -r app/* ubuntu@${appIP}:/home/deploy/app/
                        ssh -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@${appIP} 'sudo chown -R deploy:deploy /home/deploy/app && sudo systemctl restart cicd-app.service'
                    """
                  }
              }
           }
        }
     }

       stage('Smoke Test') {
            steps {
                script {
                    def outputs = readJSON file: 'terraform/outputs.json'
                    def ip = outputs.app_public_ip.value

                    // Wait for service startup
                    sleep 10

                    sh "curl -f http://${ip}:3000/ || (echo 'Smoke test failed' && exit 1)"
                }
            }
        }
    }

     post {
	success { 
	   echo 'Pipeline succeeded'
	}
	failure {
	   echo 'Pipeline failed'
	}
     }

} 
	
